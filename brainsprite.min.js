function brainsprite(d){function a(f,e){f.imageSmoothingEnabled=e;return f}var b={};var c={nanValue:false,smooth:false,fastDraw:false,colorBackground:"#000000",flagCoordinates:false,origin:{X:0,Y:0,Z:0},voxelSize:1,heightColorBar:0.04,sizeFont:0.075,colorFont:"#FFFFFF",nbDecimals:3,};var b=Object.assign({},c,d);b.canvas=document.getElementById(d.canvas);b.context=b.canvas.getContext("2d");b.context=a(b.context,b.smooth);b.canvasY=document.createElement("canvas");b.contextY=b.canvasY.getContext("2d");b.canvasZ=document.createElement("canvas");b.contextZ=b.canvasZ.getContext("2d");b.canvasRead=document.createElement("canvas");b.contextRead=b.canvasRead.getContext("2d");b.canvasRead.width=1;b.canvasRead.height=1;b.onclick=typeof d.onclick!=="undefined"?d.onclick:"";if(b.flagCoordinates){b.spaceFont=0.1}else{b.spaceFont=0}b.sprite=document.getElementById(d.sprite);b.nbCol=b.sprite.width/d.nbSlice.Y;b.nbRow=b.sprite.height/d.nbSlice.Z;b.nbSlice={X:b.nbCol*b.nbRow,Y:d.nbSlice.Y,Z:d.nbSlice.Z};b.widthCanvas={X:0,Y:0,Z:0};b.heightCanvas={X:0,Y:0,Z:0,max:0};b.numSlice={X:Math.floor(b.nbSlice.X/2),Y:Math.floor(b.nbSlice.Y/2),Z:Math.floor(b.nbSlice.Z/2)};b.coordinatesSlice={X:0,Y:0,Z:0};b.planes={};b.planes.canvasX=document.createElement("canvas");b.planes.contextX=b.planes.canvasX.getContext("2d");d.overlay=typeof d.overlay!=="undefined"?d.overlay:false;if(d.overlay){b.overlay={};b.overlay.sprite=document.getElementById(d.overlay.sprite);b.overlay.nbCol=b.overlay.sprite.width/d.overlay.nbSlice.Y;b.overlay.nbRow=b.overlay.sprite.height/d.overlay.nbSlice.Z;b.overlay.nbSlice={X:b.overlay.nbCol*b.overlay.nbRow,Y:d.overlay.nbSlice.Y,Z:d.overlay.nbSlice.Z};b.overlay.opacity=typeof d.overlay.opacity!=="undefined"?d.overlay.opacity:1}d.colorMap=typeof d.colorMap!=="undefined"?d.colorMap:false;if(d.colorMap){b.colorMap={};b.colorMap.img=document.getElementById(d.colorMap.img);b.colorMap.min=d.colorMap.min;b.colorMap.max=d.colorMap.max;d.colorMap.hide=typeof d.colorMap.hide!=="undefined"?d.colorMap.hide:false;b.colorMap.canvas=document.createElement("canvas");b.colorMap.context=b.colorMap.canvas.getContext("2d");b.colorMap.canvas.width=b.colorMap.img.width;b.colorMap.canvas.height=b.colorMap.img.height;b.colorMap.context.drawImage(b.colorMap.img,0,0,b.colorMap.img.width,b.colorMap.img.height,0,0,b.colorMap.img.width,b.colorMap.img.height)}b.getValue=function(i,h){if(!h){return NaN}var f,l,e,j,k,g;e=h.canvas.width;j=NaN;k=Infinity;for(xx=0;xx<e;xx++){f=h.context.getImageData(xx,0,1,1).data;l=Math.pow(f[0]-i[0],2)+Math.pow(f[1]-i[1],2)+Math.pow(f[2]-i[2],2);if(l<k){j=xx;k=l}}g=(j*(h.max-h.min)/(e-1))+h.min;return g};b.init=function(){b.widthCanvas.X=Math.floor(b.canvas.parentElement.clientWidth*(b.nbSlice.Y/(2*b.nbSlice.X+b.nbSlice.Y)));b.widthCanvas.Y=Math.floor(b.canvas.parentElement.clientWidth*(b.nbSlice.X/(2*b.nbSlice.X+b.nbSlice.Y)));b.widthCanvas.Z=Math.floor(b.canvas.parentElement.clientWidth*(b.nbSlice.X/(2*b.nbSlice.X+b.nbSlice.Y)));b.heightCanvas.X=Math.floor(b.widthCanvas.X*b.nbSlice.Z/b.nbSlice.Y);b.heightCanvas.Y=Math.floor(b.widthCanvas.Y*b.nbSlice.Z/b.nbSlice.X);b.heightCanvas.Z=Math.floor(b.widthCanvas.Z*b.nbSlice.Y/b.nbSlice.X);b.heightCanvas.max=Math.max(b.heightCanvas.X,b.heightCanvas.Y,b.heightCanvas.Z);if(b.canvas.width!=(b.widthCanvas.X+b.widthCanvas.Y+b.widthCanvas.Z)){b.canvas.width=b.widthCanvas.X+b.widthCanvas.Y+b.widthCanvas.Z;b.canvas.height=Math.round((1+b.spaceFont)*(b.heightCanvas.max));b.context=a(b.context,b.smooth)}b.sizeFontPixels=Math.round(b.sizeFont*(b.heightCanvas.max));b.context.font=b.sizeFontPixels+"px Arial";b.planes.canvasX.width=b.sprite.width;b.planes.canvasX.height=b.sprite.height;b.planes.contextX.globalAlpha=1;b.planes.contextX.drawImage(b.sprite,0,0,b.sprite.width,b.sprite.height,0,0,b.sprite.width,b.sprite.height);if(b.overlay){b.planes.contextX.globalAlpha=b.overlay.opacity;b.planes.contextX.drawImage(b.overlay.sprite,0,0,b.overlay.sprite.width,b.overlay.sprite.height,0,0,b.sprite.width,b.sprite.height)}b.planes.canvasY=document.createElement("canvas");b.planes.contextY=b.planes.canvasY.getContext("2d");if(b.fastDraw){b.planes.canvasY.width=b.nbSlice.X*b.nbCol;b.planes.canvasY.height=b.nbSlice.Z*Math.ceil(b.nbSlice.Y/b.nbCol);var e={};for(yy=0;yy<b.nbSlice.Y;yy++){for(xx=0;xx<b.nbSlice.X;xx++){e.XW=(xx%b.nbCol);e.XH=(xx-e.XW)/b.nbCol;e.YW=(yy%b.nbCol);e.YH=(yy-e.YW)/b.nbCol;b.planes.contextY.globalAlpha=1;b.planes.contextY.drawImage(b.sprite,e.XW*b.nbSlice.Y+yy,e.XH*b.nbSlice.Z,1,b.nbSlice.Z,e.YW*b.nbSlice.X+xx,e.YH*b.nbSlice.Z,1,b.nbSlice.Z);if(b.overlay){b.planes.contextY.globalAlpha=b.overlay.opacity;b.planes.contextY.drawImage(b.overlay.sprite,e.XW*b.nbSlice.Y+yy,e.XH*b.nbSlice.Z,1,b.nbSlice.Z,e.YW*b.nbSlice.X+xx,e.YH*b.nbSlice.Z,1,b.nbSlice.Z)}}}}else{b.planes.canvasY.width=b.nbSlice.X;b.planes.canvasY.height=b.nbSlice.Z}b.planes.canvasZ=document.createElement("canvas");b.planes.contextZ=b.planes.canvasZ.getContext("2d");if(b.fastDraw){b.planes.canvasZ.height=Math.max(b.nbSlice.X*b.nbCol,b.nbSlice.Y*Math.ceil(b.nbSlice.Z/b.nbCol));b.planes.canvasZ.width=b.planes.canvasZ.height;b.planes.contextZ.rotate(-Math.PI/2);b.planes.contextZ.translate(-b.planes.canvasZ.width,0);var e={};for(zz=0;zz<b.nbSlice.Z;zz++){for(xx=0;xx<b.nbSlice.X;xx++){e.XW=(xx%b.nbCol);e.XH=(xx-e.XW)/b.nbCol;e.ZH=zz%b.nbCol;e.ZW=Math.ceil(b.nbSlice.Z/b.nbCol)-1-((zz-e.ZH)/b.nbCol);b.planes.contextZ.globalAlpha=1;b.planes.contextZ.drawImage(b.sprite,e.XW*b.nbSlice.Y,e.XH*b.nbSlice.Z+zz,b.nbSlice.Y,1,e.ZW*b.nbSlice.Y,e.ZH*b.nbSlice.X+xx,b.nbSlice.Y,1);if(b.overlay){b.planes.contextZ.globalAlpha=b.overlay.opacity;b.planes.contextZ.drawImage(b.overlay.sprite,e.XW*b.nbSlice.Y,e.XH*b.nbSlice.Z+zz,b.nbSlice.Y,1,e.ZW*b.nbSlice.Y,e.ZH*b.nbSlice.X+xx,b.nbSlice.Y,1)}}}}else{b.planes.canvasZ.width=b.nbSlice.X;b.planes.canvasZ.height=b.nbSlice.Y;b.planes.contextZ.rotate(-Math.PI/2);b.planes.contextZ.translate(-b.nbSlice.Y,0)}};b.draw=function(h,f){var j={},i,e;b.numSlice[f]=h;b.coordinatesSlice.X=(b.numSlice.X*b.voxelSize)-b.origin.X;b.coordinatesSlice.Y=(b.numSlice.Y*b.voxelSize)-b.origin.Y;b.coordinatesSlice.Z=((b.nbSlice.Z-b.numSlice.Z-1)*b.voxelSize)-b.origin.Z;if(b.overlay&&!b.nanValue){try{j.XW=((b.numSlice.X)%b.nbCol);j.XH=(b.numSlice.X-j.XW)/b.nbCol;b.contextRead.drawImage(b.overlay.sprite,j.XW*b.nbSlice.Y+b.numSlice.Y,j.XH*b.nbSlice.Z+b.numSlice.Z,1,1,0,0,1,1);rgb=b.contextRead.getImageData(0,0,1,1).data;b.voxelValue=b.getValue(rgb,b.colorMap)}catch(g){console.warn(g.message);rgb=0;b.nanValue=true;b.voxelValue=NaN}}else{b.voxelValue=NaN}switch(f){case"X":j.XW=((b.numSlice.X)%b.nbCol);j.XH=(b.numSlice.X-j.XW)/b.nbCol;b.context.fillStyle=b.colorBackground;b.context.fillRect(0,0,b.widthCanvas.X,b.canvas.height);b.context.drawImage(b.planes.canvasX,j.XW*b.nbSlice.Y,j.XH*b.nbSlice.Z,b.nbSlice.Y,b.nbSlice.Z,0,(b.heightCanvas.max-b.heightCanvas.X)/2,b.widthCanvas.X,b.heightCanvas.X);if(b.flagCoordinates){i="x="+b.coordinatesSlice.X;e=b.context.measureText(i).width;b.context.fillStyle=b.colorFont;b.context.fillText(i,b.widthCanvas.X/2-e/2,Math.round(b.canvas.height-(b.sizeFontPixels/2)))}break;case"Y":b.context.fillStyle=b.colorBackground;b.context.fillRect(b.widthCanvas.X,0,b.widthCanvas.Y,b.canvas.height);if(b.fastDraw){j.YW=(b.numSlice.Y%b.nbCol);j.YH=(b.numSlice.Y-j.YW)/b.nbCol;b.context.drawImage(b.planes.canvasY,j.YW*b.nbSlice.X,j.YH*b.nbSlice.Z,b.nbSlice.X,b.nbSlice.Z,b.widthCanvas.X,(b.heightCanvas.max-b.heightCanvas.Y)/2,b.widthCanvas.Y,b.heightCanvas.Y)}else{for(xx=0;xx<b.nbSlice.X;xx++){posW=(xx%b.nbCol);posH=(xx-posW)/b.nbCol;b.planes.contextY.drawImage(b.planes.canvasX,posW*b.nbSlice.Y+b.numSlice.Y,posH*b.nbSlice.Z,1,b.nbSlice.Z,xx,0,1,b.nbSlice.Z)}b.context.drawImage(b.planes.canvasY,0,0,b.nbSlice.X,b.nbSlice.Z,b.widthCanvas.X,(b.heightCanvas.max-b.heightCanvas.Y)/2,b.widthCanvas.Y,b.heightCanvas.Y)}if((b.colorMap)&&(!b.colorMap.hide)){b.context.drawImage(b.colorMap.img,0,0,b.colorMap.img.width,1,Math.round(b.widthCanvas.X+b.widthCanvas.Y*0.2),Math.round(b.heightCanvas.max*b.heightColorBar/2),Math.round(b.widthCanvas.Y*0.6),Math.round(b.heightCanvas.max*b.heightColorBar));b.context.fillStyle=b.colorFont;b.context.fillText(Number.parseFloat(b.colorMap.min).toPrecision(b.nbDecimals).replace(/0+$/,""),b.widthCanvas.X+(b.widthCanvas.Y*0.2),Math.round((b.heightCanvas.max*b.heightColorBar*2)+(3/4)*(b.sizeFontPixels)));b.context.fillText(Number.parseFloat(b.colorMap.max).toPrecision(b.nbDecimals).replace(/0+$/,""),b.widthCanvas.X+(b.widthCanvas.Y*0.8)-b.context.measureText(b.colorMap.max).width,Math.round((b.heightCanvas.max*b.heightColorBar*2)+(3/4)*(b.sizeFontPixels)))}if(b.flagCoordinates){b.context.font=b.sizeFontPixels+"px Arial";b.context.fillStyle=b.colorFont;i="y="+b.coordinatesSlice.Y;e=b.context.measureText(i).width;b.context.fillText(i,b.widthCanvas.X+(b.widthCanvas.Y/2)-e/2,Math.round(b.canvas.height-(b.sizeFontPixels/2)))}case"Z":b.context.fillStyle=b.colorBackground;b.context.fillRect(b.widthCanvas.X+b.widthCanvas.Y,0,b.widthCanvas.Z,b.canvas.height);if(b.fastDraw){j.ZW=(b.numSlice.Z%b.nbCol);j.ZH=(b.numSlice.Z-j.ZW)/b.nbCol;b.context.drawImage(b.planes.canvasZ,j.ZW*b.nbSlice.X,j.ZH*b.nbSlice.Y,b.nbSlice.X,b.nbSlice.Y,b.widthCanvas.X+b.widthCanvas.Y,(b.heightCanvas.max-b.heightCanvas.Z)/2,b.widthCanvas.Z,b.heightCanvas.Z)}else{for(xx=0;xx<b.nbSlice.X;xx++){posW=(xx%b.nbCol);posH=(xx-posW)/b.nbCol;b.planes.contextZ.drawImage(b.planes.canvasX,posW*b.nbSlice.Y,posH*b.nbSlice.Z+b.numSlice.Z,b.nbSlice.Y,1,0,xx,b.nbSlice.Y,1)}b.context.drawImage(b.planes.canvasZ,0,0,b.nbSlice.X,b.nbSlice.Y,b.widthCanvas.X+b.widthCanvas.Y,(b.heightCanvas.max-b.heightCanvas.Z)/2,b.widthCanvas.Z,b.heightCanvas.Z)}if(b.flagCoordinates){i="z="+b.coordinatesSlice.Z;e=b.context.measureText(i).width;b.context.fillStyle=b.colorFont;b.context.fillText(i,b.widthCanvas.X+b.widthCanvas.Y+(b.widthCanvas.Z/2)-e/2,Math.round(b.canvas.height-(b.sizeFontPixels/2)))}}};b.clickBrain=function(h){var f=b.canvas.getBoundingClientRect();var j=h.clientX-f.left;var k=h.clientY-f.top;var i,g;if(j<b.widthCanvas.X){i=Math.round(b.nbSlice.Y*(j/b.widthCanvas.X));g=Math.round(b.nbSlice.Z*(k-((b.heightCanvas.max-b.heightCanvas.X)/2))/b.heightCanvas.X);b.draw(Math.max(Math.min(i,b.nbSlice.Y-1),0),"Y");b.draw(Math.max(Math.min(g,b.nbSlice.Z-1),0),"Z")}else{if(j<(b.widthCanvas.X+b.widthCanvas.Y)){j=j-b.widthCanvas.X;sx=Math.round(b.nbSlice.X*(j/b.widthCanvas.Y));g=Math.round(b.nbSlice.Z*(k-((b.heightCanvas.max-b.heightCanvas.Y)/2))/b.heightCanvas.Y);b.draw(Math.max(Math.min(sx,b.nbSlice.X-1),0),"X");b.draw(Math.max(Math.min(g,b.nbSlice.Z-1),0),"Z")}else{j=j-b.widthCanvas.X-b.widthCanvas.Y;sx=Math.round(b.nbSlice.X*(j/b.widthCanvas.Z));i=Math.round(b.nbSlice.Y*(1-((k-((b.heightCanvas.max-b.heightCanvas.Z)/2))/b.heightCanvas.Z)));b.draw(Math.max(Math.min(sx,b.nbSlice.X-1),0),"X");b.draw(Math.max(Math.min(i,b.nbSlice.Y-1),0),"Y");b.draw(b.numSlice.Z,"Z")}}if(b.onclick){b.onclick(h)}};b.drawAll=function(){b.draw(b.numSlice.X,"X");b.draw(b.numSlice.Y,"Y");b.draw(b.numSlice.Z,"Z")};b.canvas.addEventListener("click",b.clickBrain,false);b.canvas.addEventListener("mousedown",function(f){b.canvas.addEventListener("mousemove",b.clickBrain,false)},false);b.canvas.addEventListener("mouseup",function(f){b.canvas.removeEventListener("mousemove",b.clickBrain,false)},false);b.sprite.addEventListener("load",function(){b.init();b.drawAll()});if(b.overlay){b.overlay.sprite.addEventListener("load",function(){b.init();b.drawAll()})}b.init();b.drawAll();return b};