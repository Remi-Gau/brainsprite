function brainsprite(c){function a(e,d){e.imageSmoothingEnabled=d;return e}var b={};b.nanValue=false;b.smooth=typeof c.smooth!=="undefined"?c.smooth:false;b.fastDraw=typeof c.fastDraw!=="undefined"?c.fastDraw:false;b.canvas=document.getElementById(c.canvas);b.context=b.canvas.getContext("2d");b.context=a(b.context,b.smooth);b.canvasY=document.createElement("canvas");b.contextY=b.canvasY.getContext("2d");b.canvasZ=document.createElement("canvas");b.contextZ=b.canvasZ.getContext("2d");b.canvasRead=document.createElement("canvas");b.contextRead=b.canvasRead.getContext("2d");b.canvasRead.width=1;b.canvasRead.height=1;b.onclick=typeof c.onclick!=="undefined"?c.onclick:"";b.colorBackground=typeof c.colorBackground!=="undefined"?c.colorBackground:"#000000";b.flagCoordinates=typeof c.flagCoordinates!=="undefined"?c.flagCoordinates:false;b.origin=typeof c.origin!=="undefined"?c.origin:{X:0,Y:0,Z:0};b.voxelSize=typeof c.voxelSize!=="undefined"?c.voxelSize:1;b.heightColorBar=0.04;b.sizeFont=0.075;b.colorFont=typeof c.colorFont!=="undefined"?c.colorFont:"#FFFFFF";if(b.flagCoordinates){b.spaceFont=0.1}else{b.spaceFont=0}b.sprite=document.getElementById(c.sprite);b.nbCol=b.sprite.width/c.nbSlice.Y;b.nbRow=b.sprite.height/c.nbSlice.Z;b.nbSlice={X:b.nbCol*b.nbRow,Y:c.nbSlice.Y,Z:c.nbSlice.Z};b.widthCanvas={X:0,Y:0,Z:0};b.heightCanvas={X:0,Y:0,Z:0,max:0};b.numSlice={X:Math.floor(b.nbSlice.X/2),Y:Math.floor(b.nbSlice.Y/2),Z:Math.floor(b.nbSlice.Z/2)};b.coordinatesSlice={X:0,Y:0,Z:0};b.planes={};b.planes.canvasX=document.createElement("canvas");b.planes.contextX=b.planes.canvasX.getContext("2d");c.overlay=typeof c.overlay!=="undefined"?c.overlay:false;if(c.overlay){b.overlay={};b.overlay.sprite=document.getElementById(c.overlay.sprite);b.overlay.nbCol=b.overlay.sprite.width/c.overlay.nbSlice.Y;b.overlay.nbRow=b.overlay.sprite.height/c.overlay.nbSlice.Z;b.overlay.nbSlice={X:b.overlay.nbCol*b.overlay.nbRow,Y:c.overlay.nbSlice.Y,Z:c.overlay.nbSlice.Z};b.overlay.opacity=typeof c.overlay.opacity!=="undefined"?c.overlay.opacity:1}c.colorMap=typeof c.colorMap!=="undefined"?c.colorMap:false;if(c.colorMap){b.colorMap={};b.colorMap.img=document.getElementById(c.colorMap.img);b.colorMap.min=c.colorMap.min;b.colorMap.max=c.colorMap.max;c.colorMap.hide=typeof c.colorMap.hide!=="undefined"?c.colorMap.hide:false;b.colorMap.canvas=document.createElement("canvas");b.colorMap.context=b.colorMap.canvas.getContext("2d");b.colorMap.canvas.width=b.colorMap.img.width;b.colorMap.canvas.height=b.colorMap.img.height;b.colorMap.context.drawImage(b.colorMap.img,0,0,b.colorMap.img.width,b.colorMap.img.height,0,0,b.colorMap.img.width,b.colorMap.img.height)}b.getValue=function(h,g){if(!g){return NaN}var e,k,d,i,j,f;d=g.canvas.width;i=NaN;j=Infinity;for(xx=0;xx<d;xx++){e=g.context.getImageData(xx,0,1,1).data;k=Math.pow(e[0]-h[0],2)+Math.pow(e[1]-h[1],2)+Math.pow(e[2]-h[2],2);if(k<j){i=xx;j=k}}f=(i*(g.max-g.min)/(d-1))+g.min;return f};b.init=function(){b.widthCanvas.X=Math.floor(b.canvas.parentElement.clientWidth*(b.nbSlice.Y/(2*b.nbSlice.X+b.nbSlice.Y)));b.widthCanvas.Y=Math.floor(b.canvas.parentElement.clientWidth*(b.nbSlice.X/(2*b.nbSlice.X+b.nbSlice.Y)));b.widthCanvas.Z=Math.floor(b.canvas.parentElement.clientWidth*(b.nbSlice.X/(2*b.nbSlice.X+b.nbSlice.Y)));b.heightCanvas.X=Math.floor(b.widthCanvas.X*b.nbSlice.Z/b.nbSlice.Y);b.heightCanvas.Y=Math.floor(b.widthCanvas.Y*b.nbSlice.Z/b.nbSlice.X);b.heightCanvas.Z=Math.floor(b.widthCanvas.Z*b.nbSlice.Y/b.nbSlice.X);b.heightCanvas.max=Math.max(b.heightCanvas.X,b.heightCanvas.Y,b.heightCanvas.Z);if(b.canvas.width!=(b.widthCanvas.X+b.widthCanvas.Y+b.widthCanvas.Z)){b.canvas.width=b.widthCanvas.X+b.widthCanvas.Y+b.widthCanvas.Z;b.canvas.height=Math.round((1+b.spaceFont)*(b.heightCanvas.max));b.context=a(b.context,b.smooth)}b.sizeFontPixels=Math.round(b.sizeFont*(b.heightCanvas.max));b.context.font=b.sizeFontPixels+"px Arial";b.planes.canvasX.width=b.sprite.width;b.planes.canvasX.height=b.sprite.height;b.planes.contextX.globalAlpha=1;b.planes.contextX.drawImage(b.sprite,0,0,b.sprite.width,b.sprite.height,0,0,b.sprite.width,b.sprite.height);if(b.overlay){b.planes.contextX.globalAlpha=b.overlay.opacity;b.planes.contextX.drawImage(b.overlay.sprite,0,0,b.overlay.sprite.width,b.overlay.sprite.height,0,0,b.sprite.width,b.sprite.height)}b.planes.canvasY=document.createElement("canvas");b.planes.contextY=b.planes.canvasY.getContext("2d");if(b.fastDraw){b.planes.canvasY.width=b.nbSlice.X*b.nbCol;b.planes.canvasY.height=b.nbSlice.Z*Math.ceil(b.nbSlice.Y/b.nbCol);var d={};for(yy=0;yy<b.nbSlice.Y;yy++){for(xx=0;xx<b.nbSlice.X;xx++){d.XW=(xx%b.nbCol);d.XH=(xx-d.XW)/b.nbCol;d.YW=(yy%b.nbCol);d.YH=(yy-d.YW)/b.nbCol;b.planes.contextY.globalAlpha=1;b.planes.contextY.drawImage(b.sprite,d.XW*b.nbSlice.Y+yy,d.XH*b.nbSlice.Z,1,b.nbSlice.Z,d.YW*b.nbSlice.X+xx,d.YH*b.nbSlice.Z,1,b.nbSlice.Z);if(b.overlay){b.planes.contextY.globalAlpha=b.overlay.opacity;b.planes.contextY.drawImage(b.overlay.sprite,d.XW*b.nbSlice.Y+yy,d.XH*b.nbSlice.Z,1,b.nbSlice.Z,d.YW*b.nbSlice.X+xx,d.YH*b.nbSlice.Z,1,b.nbSlice.Z)}}}}else{b.planes.canvasY.width=b.nbSlice.X;b.planes.canvasY.height=b.nbSlice.Z}b.planes.canvasZ=document.createElement("canvas");b.planes.contextZ=b.planes.canvasZ.getContext("2d");if(b.fastDraw){b.planes.canvasZ.height=Math.max(b.nbSlice.X*b.nbCol,b.nbSlice.Y*Math.ceil(b.nbSlice.Z/b.nbCol));b.planes.canvasZ.width=b.planes.canvasZ.height;b.planes.contextZ.rotate(-Math.PI/2);b.planes.contextZ.translate(-b.planes.canvasZ.width,0);var d={};for(zz=0;zz<b.nbSlice.Z;zz++){for(xx=0;xx<b.nbSlice.X;xx++){d.XW=(xx%b.nbCol);d.XH=(xx-d.XW)/b.nbCol;d.ZH=zz%b.nbCol;d.ZW=Math.ceil(b.nbSlice.Z/b.nbCol)-1-((zz-d.ZH)/b.nbCol);b.planes.contextZ.globalAlpha=1;b.planes.contextZ.drawImage(b.sprite,d.XW*b.nbSlice.Y,d.XH*b.nbSlice.Z+zz,b.nbSlice.Y,1,d.ZW*b.nbSlice.Y,d.ZH*b.nbSlice.X+xx,b.nbSlice.Y,1);if(b.overlay){b.planes.contextZ.globalAlpha=b.overlay.opacity;b.planes.contextZ.drawImage(b.overlay.sprite,d.XW*b.nbSlice.Y,d.XH*b.nbSlice.Z+zz,b.nbSlice.Y,1,d.ZW*b.nbSlice.Y,d.ZH*b.nbSlice.X+xx,b.nbSlice.Y,1)}}}}else{b.planes.canvasZ.width=b.nbSlice.X;b.planes.canvasZ.height=b.nbSlice.Y;b.planes.contextZ.rotate(-Math.PI/2);b.planes.contextZ.translate(-b.nbSlice.Y,0)}};b.draw=function(g,e){var i={},h,d;b.numSlice[e]=g;b.coordinatesSlice.X=(b.numSlice.X*b.voxelSize)-b.origin.X;b.coordinatesSlice.Y=(b.numSlice.Y*b.voxelSize)-b.origin.Y;b.coordinatesSlice.Z=((b.nbSlice.Z-b.numSlice.Z-1)*b.voxelSize)-b.origin.Z;if(b.overlay&&!b.nanValue){try{i.XW=((b.numSlice.X)%b.nbCol);i.XH=(b.numSlice.X-i.XW)/b.nbCol;b.contextRead.drawImage(b.overlay.sprite,i.XW*b.nbSlice.Y+b.numSlice.Y,i.XH*b.nbSlice.Z+b.numSlice.Z,1,1,0,0,1,1);rgb=b.contextRead.getImageData(0,0,1,1).data;b.voxelValue=b.getValue(rgb,b.colorMap)}catch(f){console.warn(f.message);rgb=0;b.nanValue=true;b.voxelValue=NaN}}else{b.voxelValue=NaN}switch(e){case"X":i.XW=((b.numSlice.X)%b.nbCol);i.XH=(b.numSlice.X-i.XW)/b.nbCol;b.context.fillStyle=b.colorBackground;b.context.fillRect(0,0,b.widthCanvas.X,b.canvas.height);b.context.drawImage(b.planes.canvasX,i.XW*b.nbSlice.Y,i.XH*b.nbSlice.Z,b.nbSlice.Y,b.nbSlice.Z,0,(b.heightCanvas.max-b.heightCanvas.X)/2,b.widthCanvas.X,b.heightCanvas.X);if(b.flagCoordinates){h="x="+b.coordinatesSlice.X;d=b.context.measureText(h).width;b.context.fillStyle=b.colorFont;b.context.fillText(h,b.widthCanvas.X/2-d/2,Math.round(b.canvas.height-(b.sizeFontPixels/2)))}break;case"Y":b.context.fillStyle=b.colorBackground;b.context.fillRect(b.widthCanvas.X,0,b.widthCanvas.Y,b.canvas.height);if(b.fastDraw){i.YW=(b.numSlice.Y%b.nbCol);i.YH=(b.numSlice.Y-i.YW)/b.nbCol;b.context.drawImage(b.planes.canvasY,i.YW*b.nbSlice.X,i.YH*b.nbSlice.Z,b.nbSlice.X,b.nbSlice.Z,b.widthCanvas.X,(b.heightCanvas.max-b.heightCanvas.Y)/2,b.widthCanvas.Y,b.heightCanvas.Y)}else{for(xx=0;xx<b.nbSlice.X;xx++){posW=(xx%b.nbCol);posH=(xx-posW)/b.nbCol;b.planes.contextY.drawImage(b.planes.canvasX,posW*b.nbSlice.Y+b.numSlice.Y,posH*b.nbSlice.Z,1,b.nbSlice.Z,xx,0,1,b.nbSlice.Z)}b.context.drawImage(b.planes.canvasY,0,0,b.nbSlice.X,b.nbSlice.Z,b.widthCanvas.X,(b.heightCanvas.max-b.heightCanvas.Y)/2,b.widthCanvas.Y,b.heightCanvas.Y)}if((b.colorMap)&&(!b.colorMap.hide)){b.context.drawImage(b.colorMap.img,0,0,b.colorMap.img.width,1,Math.round(b.widthCanvas.X+b.widthCanvas.Y*0.2),Math.round(b.heightCanvas.max*b.heightColorBar/2),Math.round(b.widthCanvas.Y*0.6),Math.round(b.heightCanvas.max*b.heightColorBar));b.context.fillStyle=b.colorFont;b.context.fillText(b.colorMap.min,b.widthCanvas.X+(b.widthCanvas.Y*0.2),Math.round((b.heightCanvas.max*b.heightColorBar*2)+(3/4)*(b.sizeFontPixels)));b.context.fillText(b.colorMap.max,b.widthCanvas.X+(b.widthCanvas.Y*0.8)-b.context.measureText(b.colorMap.max).width,Math.round((b.heightCanvas.max*b.heightColorBar*2)+(3/4)*(b.sizeFontPixels)))}if(b.flagCoordinates){b.context.font=b.sizeFontPixels+"px Arial";b.context.fillStyle=b.colorFont;h="y="+b.coordinatesSlice.Y;d=b.context.measureText(h).width;b.context.fillText(h,b.widthCanvas.X+(b.widthCanvas.Y/2)-d/2,Math.round(b.canvas.height-(b.sizeFontPixels/2)))}case"Z":b.context.fillStyle=b.colorBackground;b.context.fillRect(b.widthCanvas.X+b.widthCanvas.Y,0,b.widthCanvas.Z,b.canvas.height);if(b.fastDraw){i.ZW=(b.numSlice.Z%b.nbCol);i.ZH=(b.numSlice.Z-i.ZW)/b.nbCol;b.context.drawImage(b.planes.canvasZ,i.ZW*b.nbSlice.X,i.ZH*b.nbSlice.Y,b.nbSlice.X,b.nbSlice.Y,b.widthCanvas.X+b.widthCanvas.Y,(b.heightCanvas.max-b.heightCanvas.Z)/2,b.widthCanvas.Z,b.heightCanvas.Z)}else{for(xx=0;xx<b.nbSlice.X;xx++){posW=(xx%b.nbCol);posH=(xx-posW)/b.nbCol;b.planes.contextZ.drawImage(b.planes.canvasX,posW*b.nbSlice.Y,posH*b.nbSlice.Z+b.numSlice.Z,b.nbSlice.Y,1,0,xx,b.nbSlice.Y,1)}b.context.drawImage(b.planes.canvasZ,0,0,b.nbSlice.X,b.nbSlice.Y,b.widthCanvas.X+b.widthCanvas.Y,(b.heightCanvas.max-b.heightCanvas.Z)/2,b.widthCanvas.Z,b.heightCanvas.Z)}if(b.flagCoordinates){h="z="+b.coordinatesSlice.Z;d=b.context.measureText(h).width;b.context.fillStyle=b.colorFont;b.context.fillText(h,b.widthCanvas.X+b.widthCanvas.Y+(b.widthCanvas.Z/2)-d/2,Math.round(b.canvas.height-(b.sizeFontPixels/2)))}}};b.clickBrain=function(g){var d=b.canvas.getBoundingClientRect();var i=g.clientX-d.left;var j=g.clientY-d.top;var h,f;if(i<b.widthCanvas.X){h=Math.round(b.nbSlice.Y*(i/b.widthCanvas.X));f=Math.round(b.nbSlice.Z*(j-((b.heightCanvas.max-b.heightCanvas.X)/2))/b.heightCanvas.X);b.draw(Math.max(Math.min(h,b.nbSlice.Y-1),0),"Y");b.draw(Math.max(Math.min(f,b.nbSlice.Z-1),0),"Z")}else{if(i<(b.widthCanvas.X+b.widthCanvas.Y)){i=i-b.widthCanvas.X;sx=Math.round(b.nbSlice.X*(i/b.widthCanvas.Y));f=Math.round(b.nbSlice.Z*(j-((b.heightCanvas.max-b.heightCanvas.Y)/2))/b.heightCanvas.Y);b.draw(Math.max(Math.min(sx,b.nbSlice.X-1),0),"X");b.draw(Math.max(Math.min(f,b.nbSlice.Z-1),0),"Z")}else{i=i-b.widthCanvas.X-b.widthCanvas.Y;sx=Math.round(b.nbSlice.X*(i/b.widthCanvas.Z));h=Math.round(b.nbSlice.Y*(1-((j-((b.heightCanvas.max-b.heightCanvas.Z)/2))/b.heightCanvas.Z)));b.draw(Math.max(Math.min(sx,b.nbSlice.X-1),0),"X");b.draw(Math.max(Math.min(h,b.nbSlice.Y-1),0),"Y");b.draw(b.numSlice.Z,"Z")}}if(b.onclick){b.onclick(g)}};b.drawAll=function(){b.draw(b.numSlice.X,"X");b.draw(b.numSlice.Y,"Y");b.draw(b.numSlice.Z,"Z")};b.canvas.addEventListener("click",b.clickBrain,false);b.canvas.addEventListener("mousedown",function(d){b.canvas.addEventListener("mousemove",b.clickBrain,false)},false);b.canvas.addEventListener("mouseup",function(d){b.canvas.removeEventListener("mousemove",b.clickBrain,false)},false);b.sprite.addEventListener("load",function(){b.init();b.drawAll()});if(b.overlay){b.overlay.sprite.addEventListener("load",function(){b.init();b.drawAll()})}b.init();b.drawAll();return b};